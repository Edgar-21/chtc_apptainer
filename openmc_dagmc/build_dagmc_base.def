Bootstrap: localimage
From: /home/edgar/research/chtc_apptainer/openmc_dagmc/openmpi-4.1.6_gcc-11.3.0.sif

%arguments
	HDF5_VERSION=hdf5_1_14_3
	MOAB_VERSION=5.5.1
	DOUBLE_DOWN_VERSION=v1.1.0
	EMBREE_VERSION=v4.0.1
	DAGMC_VERSION=v3.2.1
	BUILD_DIR=/root/build
	INSTALL_DIR=/opt
	COMPILER=gcc
	EMBREE_INSTALL_DIR=/opt/Embree
	EMBREE_BUILD_DIR=/root/build/Embree
	CC=gcc
	CXX=g++
	HDF5_BUILD_DIR=/root/build/hdf5
	HDF5_INSTALL_DIR=/opt/hdf5
	MOAB_BUILD_DIR=/root/build/moab
	MOAB_INSTALL_DIR=/opt/moab
	DOUBLE_DOWN_BUILD_DIR=/root/build/double-down
	DOUBLE_DOWN_INSTALL_DIR=/opt/double-down
	DAGMC_BUILD_DIR=/root/dagmc
	DAGMC_INSTALL_DIR=/opt/dagmc

%post
	apt-get update --yes && \
    apt-get install --yes --no-install-recommends \
        git \
        ca-certificates \
        autoconf \
        make \
        cmake \
        g++ \
        clang \
        gfortran \
        python3 \
        libpython3-dev \
        zlib1g-dev \
        libeigen3-dev && \
    apt-get clean && rm -rf /var/lib/apt/lists/*
	
	# EMBREE
	mkdir -p {{EMBREE_BUILD_DIR}}/build && \
	cd {{EMBREE_BUILD_DIR}} && \
	git clone -b {{EMBREE_VERSION}} --depth 1 https://github.com/embree/embree.git && \
	cd build && \
	cmake ../embree \
		-DCMAKE_INSTALL_PREFIX={{EMBREE_INSTALL_DIR}} \
		-DEMBREE_TASKING_SYSTEM=INTERNAL \
		-DEMBREE_ISPC_SUPPORT=OFF \
		-DEMBREE_TUTORIALS=OFF \
		-DEMBREE_TBB_ROOT=/usr && \
	make -j18 && \
	make -j18 install && \
	cd && \
	rm -rf {{EMBREE_BUILD_DIR}}

	# HDF5
	mkdir -p {{HDF5_BUILD_DIR}}/build && \
    cd {{HDF5_BUILD_DIR}} && \
    git clone -b {{HDF5_VERSION}} --depth 1 https://github.com/HDFGroup/hdf5.git && \
    cd build && \
    ../hdf5/configure --enable-shared \
        --prefix={{HDF5_INSTALL_DIR}} \
        CXX={{CXX}} \
        CC={{CC}} && \
    make -j18 && \
    make install && \
    cd && \
    rm -rf {{HDF5_BUILD_DIR}}
	PATH=$PATH:{{HDF5_INSTALL_DIR}}

	# MOAB
	mkdir -p {{MOAB_BUILD_DIR}}/build && \
    cd {{MOAB_BUILD_DIR}} && \
    git clone -b {{MOAB_VERSION}} --depth 1 https://bitbucket.org/fathomteam/moab.git && \
    cd build && \
    cmake ../moab \
        -DCMAKE_INSTALL_RPATH={{HDF5_INSTALL_DIR}}/lib:{{MOAB_INSTALL_DIR}}/lib \
        -DENABLE_HDF5=ON \
        -DHDF5_ROOT={{HDF5_INSTALL_DIR}} \
        -DCMAKE_INSTALL_PREFIX={{MOAB_INSTALL_DIR}} \
        -DCMAKE_CXX_COMPILER={{CXX}} \
        -DCMAKE_C_COMPILER={{CC}} \
        -DENABLE_BLASLAPACK=OFF \
        -DBUILD_SHARED_LIBS=ON \
        -DENABLE_FORTRAN=OFF \
        -DENABLE_PYMOAB=OFF && \
    make -j18 && \
    make install && \
    cd && \
    rm -rf {{MOAB_BUILD_DIR}}
	PATH=$PATH:{{MOAB_INSTALL_DIR}}
	MOAB_DIR={{MOAB_INSTALL_DIR}}

	# DOUBLE DOWN
	mkdir -p {{DOUBLE_DOWN_BUILD_DIR}}/build && \
	cd {{DOUBLE_DOWN_BUILD_DIR}} && \
	git clone -b {{DOUBLE_DOWN_VERSION}} --depth 1 https://github.com/pshriwise/double-down.git && \
	cd build && \
	cmake ../double-down \
		-DMOAB_DIR={{MOAB_INSTALL_DIR}} \
		-DCMAKE_INSTALL_PREFIX={{DOUBLE_DOWN_INSTALL_DIR}} \
		-DEMBREE_DIR={{EMBREE_INSTALL_DIR}} && \
	make -j18 && \
	make -j18 install && \
	cd && \
	rm -rf {{DOUBLE_DOWN_BUILD_DIR}}
	PATH=$PATH:{{DOUBLE_DOWN_INSTALL_DIR}}

