Bootstrap: localimage
From: /software/chtc/containers/ubuntu/22.04/openmpi-4.1.6_gcc-11.3.0.sif
%files
	/home/epflug/chtc_apptainer/openmc_dagmc/hdf5-1.14.3.tar.gz /opt/hdf5-1.14.3.tar.gz

%arguments
	HDF5_VERSION=hdf5_1_14_3
	MOAB_VERSION=5.3.0
	DOUBLE_DOWN_VERSION=v1.0.0
	EMBREE_VERSION=v3.12.2
	DAGMC_VERSION=v3.2.1
	BUILD_DIR=/root/build
	INSTALL_DIR=/opt
	COMPILER=gcc
	EMBREE_INSTALL_DIR=/opt/Embree
	EMBREE_BUILD_DIR=/root/build/Embree
	CC=gcc
	CXX=g++
	HDF5_BUILD_DIR=/root/build/hdf5
	HDF5_INSTALL_DIR=/opt/hdf5
	MOAB_BUILD_DIR=/root/build/moab
	MOAB_INSTALL_DIR=/opt/moab
	DOUBLE_DOWN_BUILD_DIR=/root/build/double-down
	DOUBLE_DOWN_INSTALL_DIR=/opt/double-down
	DAGMC_BUILD_DIR=/root/dagmc
	DAGMC_INSTALL_DIR=/opt/dagmc
	OPENMC_BUILD_DIR=/root/openmc
    OPENMC_INSTALL_DIR=/opt/openmc
	CROSS_SECTIONS_DIR=/opt/cross_sections

%environment
    export PATH=/opt/openmc/bin:/usr/bin:$PATH
    export LD_LIBRARY_PATH=/opt/openmc/lib:$LD_LIBRARY_PATH
    export PYTHONPATH=/opt/openmc:$PYTHONPATH
	export OPENMC_CROSS_SECTIONS={{CROSS_SECTIONS_DIR}}/fendl-3.2-hdf5/cross_sections.xml

%post
	chmod 777 /tmp
	apt-get update
	apt-get -y upgrade
    apt-get install -y \
        git \
        ca-certificates \
        autoconf \
        make \
        cmake \
        g++ \
        clang \
        gfortran \
        python3 \
        libpython3-dev \
        zlib1g-dev \
        libeigen3-dev \
		libpng-dev \
		libnetcdf-dev

	# HDF5
	mkdir -p {{HDF5_INSTALL_DIR}}/temp
	mv /opt/hdf5-1.14.3.tar.gz {{HDF5_INSTALL_DIR}}/temp
	cd {{HDF5_INSTALL_DIR}}/temp
	tar -xvf hdf5-1.14.3.tar.gz
	cd hdf5-1.14.3
	mkdir build && \
	cd build && \
	../configure --prefix={{HDF5_INSTALL_DIR}} \
		 --enable-optimization=high --enable-shared \
		 --enable-hl \
		 --enable-build-mode=production \
		 --enable-parallel && \
	make -j8 && \
	make install
	rm -rf {{HDF5_INSTALL_DIR}}/temp

	# EMBREE
	mkdir -p {{EMBREE_BUILD_DIR}}/build && \
	cd {{EMBREE_BUILD_DIR}} && \
	git clone -b {{EMBREE_VERSION}} --depth 1 https://github.com/embree/embree.git && \
	cd build && \
	cmake ../embree \
		-DCMAKE_INSTALL_PREFIX={{EMBREE_INSTALL_DIR}} \
		-DEMBREE_TASKING_SYSTEM=INTERNAL \
		-DEMBREE_ISPC_SUPPORT=OFF \
		-DEMBREE_TUTORIALS=OFF \
		-DEMBREE_TBB_ROOT=/usr && \
	make -j18 && \
	make -j18 install && \
	cd && \
	rm -rf {{EMBREE_BUILD_DIR}}

	# MOAB
	mkdir -p {{MOAB_BUILD_DIR}}/build && \
    cd {{MOAB_BUILD_DIR}} && \
    git clone -b {{MOAB_VERSION}} --depth 1 https://bitbucket.org/fathomteam/moab.git && \
    cd build && \
    cmake ../moab \
        -DCMAKE_INSTALL_RPATH={{HDF5_INSTALL_DIR}}/lib:{{MOAB_INSTALL_DIR}}/lib \
        -DENABLE_HDF5=ON \
        -DHDF5_ROOT={{HDF5_INSTALL_DIR}} \
        -DCMAKE_INSTALL_PREFIX={{MOAB_INSTALL_DIR}} \
        -DCMAKE_CXX_COMPILER={{CXX}} \
        -DCMAKE_C_COMPILER={{CC}} \
        -DENABLE_BLASLAPACK=OFF \
        -DBUILD_SHARED_LIBS=ON \
        -DENABLE_FORTRAN=OFF \
		-DCMAKE_C_COMPILER=mpicc \
		-DCMAKE_CXX_COMPILER=mpicxx \
        -DENABLE_PYMOAB=OFF && \
    make -j18 && \
    make install && \
    cd && \
    rm -rf {{MOAB_BUILD_DIR}}
	PATH=$PATH:{{MOAB_INSTALL_DIR}}
	MOAB_DIR={{MOAB_INSTALL_DIR}}

	# DOUBLE DOWN
	mkdir -p {{DOUBLE_DOWN_BUILD_DIR}}/build && \
	cd {{DOUBLE_DOWN_BUILD_DIR}} && \
	git clone -b {{DOUBLE_DOWN_VERSION}} --depth 1 https://github.com/pshriwise/double-down.git && \
	cd build && \
	cmake ../double-down \
		-DMOAB_DIR={{MOAB_INSTALL_DIR}} \
		-DCMAKE_INSTALL_PREFIX={{DOUBLE_DOWN_INSTALL_DIR}} \
		-DEMBREE_DIR={{EMBREE_INSTALL_DIR}} && \
	make 2>/dev/null -j18 && \
	make -j18 install && \
	cd && \
	rm -rf {{DOUBLE_DOWN_BUILD_DIR}}
	PATH=$PATH:{{DOUBLE_DOWN_INSTALL_DIR}}

	mkdir -p {{DAGMC_BUILD_DIR}}/build && \
    cd {{DAGMC_BUILD_DIR}} && \
    git clone -b {{DAGMC_VERSION}} --depth 1 https://github.com/svalinn/DAGMC.git &&\
    cd build && \
    cmake ../DAGMC \
        -DBUILD_TALLY=ON \
        -DMOAB_DIR={{MOAB_INSTALL_DIR}} \
        -DBUILD_STATIC_LIBS=OFF \
        -DCMAKE_INSTALL_PREFIX={{DAGMC_INSTALL_DIR}} \
		-DCMAKE_C_COMPILER=mpicc \
		-DCMAKE_CXX_COMPILER=mpicxx \
        -DDOUBLE_DOWN=ON \
        -DDOUBLE_DOWN_DIR={{DOUBLE_DOWN_INSTALL_DIR}} \
        -Ddd_ROOT={{DOUBLE_DOWN_INSTALL_DIR}}&& \
    make -j18 && \
    make -j18 install

	cd && \
	rm -rf {{DAGMC_BUILD_DIR}}
	
	#environment variables for openmc
    export HDF5_ROOT={{HDF5_INSTALL_DIR}}
    export HDF5_INCLUDE_DIR={{HDF5_INSTALL_DIR}}/include
    export HDF5_LIBDIR={{HDF5_INSTALL_DIR}}/lib
    export METHOD=opt

	#FENDL 3.2b
	mkdir {{CROSS_SECTIONS_DIR}}
	wget -q -O - https://anl.box.com/shared/static/3cb7jetw7tmxaw6nvn77x6c578jnm2ey.xz | tar -C {{CROSS_SECTIONS_DIR}} -xJ

	# OPENMC
    mkdir -p {{OPENMC_BUILD_DIR}}/build && \
    cd {{OPENMC_BUILD_DIR}} && \
	git clone --recurse-submodules https://github.com/openmc-dev/openmc.git && \
	cd build && \
	cmake ../openmc \
        -DCMAKE_INSTALL_PREFIX=/opt/openmc \
        -DOPENMC_USE_MPI=ON\
        -DOPENMC_USE_DAGMC=ON \
        -DDAGMC_ROOT={{DAGMC_INSTALL_DIR}}\
        -DCMAKE_BUILD_TYPE=Release .. && \
	make install -j18

	cd {{OPENMC_BUILD_DIR}}/openmc
	python -m pip install .

	


